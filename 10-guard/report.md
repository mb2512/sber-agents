# Отчет по ДЗ-10: Безопасность агентных систем

## Реализованные механизмы безопасности

### 1. Маскирование чувствительных данных (PII)

Реализована многоуровневая защита персональных данных:

- **PIIMiddleware** для маскирования номеров кредитных карт:
  - Стратегия: `mask` (маскирование вместо удаления)
  - Применяется только к выходным данным (`apply_to_output=True`)
  - Тип PII: `credit_card`

- **Кастомная функция `mask_credit_card_numbers()`** с поддержкой различных форматов:
  - Формат с дефисами: `5105-1051-0510-5100` → `****-****-****-5100`
  - Формат с пробелами: `5105 1051 0510 5100` → `**** **** **** 5100`
  - Сплошной формат: `5105105105105100` → `************5100`
  - Маскируются все цифры кроме последних 4

**Пример работы:**
```
До: Ваша карта 5105-1051-0510-5100 успешно активирована
После: Ваша карта ****-****-****-5100 успешно активирована
```

![Скриншот маскирования номера карты](screenshots/bot_mask_number.jpg)

### 2. Лимиты на вызовы

Реализована защита от переполнения и злоупотреблений через кастомную логику в `_run_agent_stream()`:

- **ModelCallLimitMiddleware**: лимит **10** вызовов модели за один запуск
- **ToolCallLimitMiddleware**: лимит **10** вызовов инструментов за один запуск
- **Защита от бесконечных циклов**: максимум **50** шагов за один запуск

**Примечание:** Встроенные middleware для лимитов (`ModelCallLimitMiddleware`, `ToolCallLimitMiddleware`) недоступны в текущей версии LangChain, поэтому реализована кастомная защита с подсчетом вызовов в реальном времени и автоматической остановкой агента при превышении лимитов.

**Механизм работы:**
- Отслеживание количества шагов, вызовов модели и инструментов на каждом этапе
- Логирование счетчиков для мониторинга
- Автоматическая остановка с понятным сообщением пользователю при превышении лимита

### 3. Human-in-the-Loop

Реализована система подтверждения критичных операций через `HumanInTheLoopMiddleware`:

**Инструменты требующие подтверждения:**

1. **`open_credit_card`** - открытие кредитной/дебитовой карты
   - Параметры: тип карты, имя клиента
   - Решения: `approve` или `reject`

2. **`open_deposit`** - открытие банковского вклада
   - Параметры: имя клиента, сумма, процентная ставка, срок в месяцах, тип начисления процентов
   - Решения: `approve` или `reject`

**Механизм работы:**
1. Агент определяет необходимость вызова защищенного инструмента
2. Создается `interrupt` объект, который останавливает выполнение
3. Пользователю отправляется сообщение с деталями операции
4. Отображаются inline кнопки "✅ Подтвердить" / "❌ Отклонить"
5. После получения решения агент продолжает выполнение или отменяет операцию

### 4. Дополнительные фильтры

- **Очистка истории от пустых сообщений**: фильтрация `None` и пустых значений из истории диалога перед обработкой
- **Валидация входящих сообщений**: проверка и очистка сообщений от некорректных данных перед отправкой в агента
- **Обработка ошибок**: улучшенная обработка исключений с понятными сообщениями для пользователя

## Сложности и решения

### 1. Проблема с недоступностью встроенных middleware

**Проблема:** `ModelCallLimitMiddleware` и `ToolCallLimitMiddleware` из `langchain.agents.middleware` имеют несовместимый API или недоступны в текущей версии LangChain.

**Решение:** Реализована кастомная система лимитов напрямую в функции `_run_agent_stream()` с:
- Подсчетом вызовов модели и инструментов
- Отслеживанием количества шагов
- Автоматической остановкой при превышении лимитов
- Детальным логированием для отладки

### 2. Ошибка парсинга Markdown в Telegram

**Проблема:** При отправке interrupt сообщений с Markdown форматированием возникала ошибка `TelegramBadRequest: can't parse entities`.

**Решение:** 
- Убрано использование `parse_mode="Markdown"` при отправке interrupt сообщений
- Добавлено экранирование специальных символов в параметрах
- Сообщения теперь отправляются без форматирования для избежания ошибок

### 3. Ошибка с None/пустыми сообщениями в истории

**Проблема:** В истории диалога появлялись пустые или `None` сообщения, которые вызывали ошибку `'NoneType' object has no attribute 'strip'` при отправке в LLM.

**Решение:**
- Добавлена фильтрация пустых сообщений при извлечении истории
- Очистка входящих сообщений от `None` значений перед отправкой в агента
- Улучшена обработка ошибок с автоматическим определением проблем с историей
- Понятные сообщения пользователю о необходимости очистки истории через `/start`

### 4. Обработка пустых ответов от LLM

**Проблема:** Иногда агент возвращал `AIMessage` с пустым `content`, что вызывало ошибки при следующем запросе.

**Решение:**
- Добавлена проверка на пустой ответ с fallback сообщением
- Фильтрация пустых сообщений из истории
- Логирование предупреждений для отладки

## Инсайты

1. **Многоуровневая защита критична**: Комбинация PII middleware и кастомной функции маскирования обеспечивает надежную защиту чувствительных данных на разных уровнях обработки.

2. **Кастомная реализация может быть предпочтительнее**: Когда встроенные инструменты недоступны или имеют ограничения, кастомная реализация с полным контролем над логикой часто более гибкая и надежная.

3. **Важность валидации данных**: Фильтрация и очистка данных на всех этапах (входящие сообщения, история, выходные данные) критически важна для стабильной работы системы.

4. **Human-in-the-Loop как критичный слой безопасности**: Для финансовых операций подтверждение пользователем является не просто удобной функцией, а обязательным элементом безопасности, предотвращающим несанкционированные действия.

5. **Мониторинг и логирование**: Детальное логирование всех действий (вызовы инструментов, лимиты, ошибки) крайне важно для диагностики проблем и мониторинга безопасности системы.

## Дополнительные улучшения

- Добавлена защита от переполнения с настраиваемыми лимитами
- Улучшена обработка ошибок с автоматическим определением типа проблемы
- Реализована очистка истории от поврежденных данных
- Добавлено детальное логирование всех операций безопасности

